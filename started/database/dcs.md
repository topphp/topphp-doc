## 分布式数据库

数据访问层支持分布式数据库，包括读写分离，要启用分布式数据库，需要开启数据库配置文件中的`deploy`参数：

```php
return [
    'default'    =>    'mysql',
    'connections'    =>    [
        'mysql'    =>    [
            // 启用分布式数据库
            'deploy'    =>  1,
            // 数据库类型
            'type'        => 'mysql',
            // 服务器地址
            'hostname'    => '192.168.1.1,192.168.1.2',
            // 数据库名
            'database'    => 'demo',
            // 数据库用户名
            'username'    => 'root',
            // 数据库密码
            'password'    => '',
            // 数据库连接端口
            'hostport'    => '',
        ],
    ],
];
```

> 启用分布式数据库后，`hostname`参数是关键，`hostname`的个数决定了分布式数据库的数量，默认情况下第一个地址就是主服务器。

主从服务器支持设置不同的连接参数，包括：

| 连接参数 |
| :--- |
| username |
| password |
| hostport |
| database |
| dsn |
| charset |

如果主从服务器的上述参数一致的话，只需要设置一个，对于不同的参数，可以分别设置，例如：

```php
return [
    'default'    =>    'mysql',
    'connections'    =>    [
        'mysql'    =>    [
            // 启用分布式数据库
            'deploy'   => 1,
            // 数据库类型
            'type'     => 'mysql',
            // 服务器地址
            'hostname' => '192.168.1.1,192.168.1.2,192.168.1.3',
            // 数据库名
            'database' => 'demo',
            // 数据库用户名
            'username' => 'root,slave,slave',
            // 数据库密码
            'password' => '123456',
            // 数据库连接端口
            'hostport' => '',
            // 数据库字符集
            'charset'  => 'utf8',
        ],
    ],
];
```

> 记住，要么相同，要么每个都要设置。

分布式的数据库参数支持使用数组定义（通常为了避免多个账号和密码的误解析），例如：

```php
return [
    'default'    =>    'mysql',
    'connections'    =>    [
        'mysql'    =>    [
            // 启用分布式数据库
            'deploy'   => 1,
            // 数据库类型
            'type'     => 'mysql',
            // 服务器地址
            'hostname' =>[ '192.168.1.1','192.168.1.2','192.168.1.3'],
            // 数据库名
            'database' => 'demo',
            // 数据库用户名
            'username' => 'root,slave,slave',
            // 数据库密码
            'password' => ['123456','abc,def','hello']
            // 数据库连接端口
            'hostport' => '',
            // 数据库字符集
            'charset'  => 'utf8',
        ],
    ],
];
```

## 读写分离

还可以设置分布式数据库的读写是否分离，默认的情况下读写不分离，也就是每台服务器都可以进行读写操作，对于主从式数据库而言，需要设置读写分离，通过下面的设置就可以：

```php
    'rw_separate' => true,
```

在读写分离的情况下，默认第一个数据库配置是主服务器的配置信息，负责写入数据，如果设置了`master_num`参数，则可以支持多个主服务器写入（每次随机连接其中一个主服务器）。其它的地址都是从数据库，负责读取数据，数量不限制。每次连接从服务器并且进行读取操作的时候，系统会随机进行在从服务器中选择。同一个数据库连接的每次请求只会连接一次主服务器和从服务器，如果某次请求的从服务器连接不上，会自动切换到主服务器进行查询操作。

如果不希望随机读取，或者某种情况下其它从服务器暂时不可用，还可以设置`slave_no`指定固定服务器进行读操作，`slave_no`指定的序号表示`hostname`中数据库地址的序号，从`0`开始。

调用查询类或者模型的`CURD`操作的话，系统会自动判断当前执行的方法是读操作还是写操作并自动连接主从服务器，如果你用的是原生SQL，那么需要注意系统的默认规则： 写操作必须用数据库的`execute`方法，读操作必须用数据库的`query`方法，否则会发生主从读写错乱的情况。

发生下列情况的话，会自动连接主服务器：

* 使用了数据库的写操作方法（`execute`/`insert`/`update`/`delete`以及衍生方法）；
* 如果调用了数据库事务方法的话，会自动连接主服务器；
* 从服务器连接失败，会自动连接主服务器；
* 调用了查询构造器的`lock`方法；
* 调用了查询构造器的`master`/`readMaster`方法

> 主从数据库的数据同步工作不在框架实现，需要数据库考虑自身的同步或者复制机制。如果在大数据量或者特殊的情况下写入数据后可能会存在同步延迟的情况，可以调用`master()`方法进行主库查询操作。

> 在实际生产环境中，很多云主机的数据库分布式实现机制和本地开发会有所区别，但通常会采下面用两种方式：
>
> * 第一种：提供了写IP和读IP（一般是虚拟IP），进行数据库的读写分离操作；
> * 第二种：始终保持同一个IP连接数据库，内部会进行读写分离IP调度（阿里云就是采用该方式）。

## 主库读取

有些情况下，需要直接从主库读取数据，例如刚写入数据之后，从库数据还没来得及同步完成，你可以使用

```php
Db::name('user')
    ->where('id', 1)
    ->update(['name' => 'thinkphp']);
Db::name('user')
    ->master(true)
    ->find(1);
```

不过，实际情况远比这个要复杂，因为你并不清楚后续的方法里面是否还存在相关查询操作，这个时候我们可以配置开启数据库的`read_master`配置参数。

```php
// 开启自动主库读取
'read_master' => true,
```

开启后，一旦我们对某个数据表进行了写操作，那么当前请求的后续所有对该表的查询都会使用主库读取。



