### 服务治理 balancer

#### 什么是服务治理

>在进行城市交通规划之前首先要做的第一个事情是收集信息，要能够知道这个城市发生了什么，所以在各个路口需要安装采集探头，记录车来车往的信息。有了信息以后就需要对信息进行分析了，那么就需要可视化的图形界面，能够一眼就看出什么地方出了问题，通往哪个工厂的路坏了。发现了问题就要解决问题了，限制一下拥堵路段的流量，把去往一个公园的车辆导向到另外一个类似的公园。最后，如果把城市作为一个国家来考虑，那么每个进入这个城市的车辆都需要进行检查，看看有没有携带违禁品，最后给这些不熟悉道路的外地车规划路线。通过上面这个思考的过程，我们发现要对一个城市进行治理的时候，第一要采集信息，然后要能够对采集的信息进行监控和分析，最后根据分析的结果采取对应的治理策略。另外从整体安全的角度考虑还需要一个守门人。

因此我们也用同样的思路来思考服务治理，网关就是整个整体的守门人，日志采集，追踪工具，服务注册发现都是用来采集信息的，然后需要监控平台来展现这些采集的信息，并进行监控和分析。最后根据分析的结果采取治理策略，有的服务快撑不住了要限流，有的服务坏了要熔断，并且还能够及时的调整这些服务的配置。

#### 负载均衡
> `topphp` 提供了简单的配置方式,使服务可以分流

目前提供了一下几种均衡模式:
1. `RandomBalancer::class` 随机模式
2. `RandomWithWeightBalancer::class` 按权重随机模式
3. `RoundBalancer::class` 轮询模式

##### 使用方法

修改配置文件 `config/topphpServer.php` 中 `balancer` 参数.

```php
<?php
'clients' => [
        [
            'name'     => 'film-server',
            'balancer' => RandomBalancer::class,
            'nodes'    => [
                ['host' => '0.0.0.0', 'port' => 9502, 'weight' => 0],
                ['host' => '127.0.0.1', 'port' => 9502, 'weight' => 0]
            ],
            'options'  => [],
            'pool'     => [
                'min_connections' => 1,
                'max_connections' => 100,
                'wait_timeout'    => 10,
                'connect_timeout' => 10,
                'max_idle_time'   => 60.0
            ]
        ]
]
```